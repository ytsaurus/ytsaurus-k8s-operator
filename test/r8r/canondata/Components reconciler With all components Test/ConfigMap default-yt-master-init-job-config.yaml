data:
  client.yson: |-
    {
        "address_resolver"={
            "enable_ipv4"=%true;
            "enable_ipv6"=%false;
            retries=1000;
        };
        logging={
            writers={
            };
            rules=[
            ];
            "flush_period"=0;
        };
        driver={
            "api_version"=4;
            "cluster_name"="test-ytsaurus";
            "primary_master"={
                addresses=[
                    "ms-0.masters.ytsaurus-components.svc.cluster.local:9010";
                ];
                peers=[
                    {
                        address="ms-0.masters.ytsaurus-components.svc.cluster.local:9010";
                        voting=%true;
                    };
                ];
                "cell_id"="65726e65-ad6b7562-10259-79747361";
            };
            "discovery_connection"={
                addresses=[
                    "ds-0.discovery.ytsaurus-components.svc.cluster.local:9020";
                ];
            };
            "master_cache"={
                addresses=[
                    "msc-0.master-caches.ytsaurus-components.svc.cluster.local:9018";
                ];
                "cell_id"="65726e65-ad6b7562-10259-79747361";
                "enable_master_cache_discovery"=%false;
            };
        };
    }
  init-cluster.sh: |2-

    set -e
    set -x

    export YT_DRIVER_CONFIG_PATH=/config/client.yson
    export YTSAURUS_VERSION="$(/usr/bin/ytserver-all --version | head -c4)"
    if [ 'true' = 'true' ]; then
    /usr/bin/yt create group --attr '{name=admins}' --ignore-existing
    if [ $(/usr/bin/yt exists //sys/@provision_lock) = 'true' ]; then
    /usr/bin/yt set //sys/schemas/tablet_cell/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/tablet_action/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/tablet_cell_bundle/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/user/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/group/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/rack/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/data_center/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/cluster_node/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/access_control_object_namespace/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/access_control_object_namespace_map/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/medium/@acl '[{action=allow;subjects=[users;];permissions=[read;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]' || /usr/bin/yt set //sys/schemas/domestic_medium/@acl '[{action=allow;subjects=[users;];permissions=[read;create;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/account/@acl '[{action=allow;subjects=[users;];permissions=[read;create;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/scheduler_pool/@acl '[{action=allow;subjects=[users;];permissions=[read;create;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/scheduler_pool_tree/@acl '[{action=allow;subjects=[users;];permissions=[read;create;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/access_control_object/@acl '[{action=allow;subjects=[users;];permissions=[read;create;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    /usr/bin/yt set //sys/schemas/account_resource_usage_lease/@acl '[{action=allow;subjects=[users;];permissions=[read;write;create;];};{action=allow;subjects=[admins;];permissions=[read;write;administer;create;remove;];};]'
    fi
    /usr/bin/yt create scheduler_pool_tree --attributes '{name=default; config={nodes_filter=""}}' --ignore-existing
    if [ $(/usr/bin/yt exists //sys/pool_trees/@default_tree) = 'false' ]; then
    /usr/bin/yt set //sys/pool_trees/@default_tree default
    fi
    if [ $(/usr/bin/yt exists //sys/pools) = 'false' ]; then
    /usr/bin/yt link //sys/pool_trees/default //sys/pools
    fi
    /usr/bin/yt create scheduler_pool --attributes '{name=research; pool_tree=default}' --ignore-existing
    /usr/bin/yt create map_node //home --ignore-existing
    if [ $(/usr/bin/yt exists //sys/@provision_lock) = 'true' ]; then
    /usr/bin/yt set //sys/@cluster_connection '{
        "cluster_name"="test-ytsaurus";
        "primary_master"={
            addresses=[
                "ms-0.masters.ytsaurus-components.svc.cluster.local:9010";
            ];
            peers=[
                {
                    address="ms-0.masters.ytsaurus-components.svc.cluster.local:9010";
                    voting=%true;
                };
            ];
            "cell_id"="65726e65-ad6b7562-10259-79747361";
        };
        "discovery_connection"={
            addresses=[
                "ds-0.discovery.ytsaurus-components.svc.cluster.local:9020";
            ];
        };
        "master_cache"={
            addresses=[
                "msc-0.master-caches.ytsaurus-components.svc.cluster.local:9018";
            ];
            "cell_id"="65726e65-ad6b7562-10259-79747361";
            "enable_master_cache_discovery"=%false;
        };
    }'
    fi
    if [ $(/usr/bin/yt exists //sys/controller_agents/config/operation_options/spec_template) = 'false' ]; then
    /usr/bin/yt set //sys/controller_agents/config/operation_options/spec_template '{enable_partitioned_data_balancing=%false}' -r
    fi
    if [ $(/usr/bin/yt exists //sys/users/admin) = 'false' ]; then
    /usr/bin/yt create user --attributes '{name="admin"}' --ignore-existing
    /usr/bin/yt execute set_user_password '{user=admin;new_password_sha256="5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"}'
    /usr/bin/yt create map_node '//sys/cypress_tokens/5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8' --ignore-existing
    /usr/bin/yt set '//sys/cypress_tokens/5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8/@user' 'admin'
    /usr/bin/yt add-member admin superusers || true
    fi
    /usr/bin/yt get //sys/media//@name || /usr/bin/yt create domestic_medium --attr '{name="";}' || /usr/bin/yt create medium --attr '{name="";}'
    /usr/bin/yt get //sys/accounts/sys/@resource_limits/disk_space_per_medium/ || /usr/bin/yt set //sys/accounts/sys/@resource_limits/disk_space_per_medium/ 1073741824
    fi
    if [ 'false' = 'true' ]; then
    if [ $(/usr/bin/yt exists //sys/users/robot-hydra-persistence-uploader) = 'false' ]; then
    /usr/bin/yt create user --attributes '{name="robot-hydra-persistence-uploader"}' --ignore-existing
    /usr/bin/yt execute set_user_password '{user=robot-hydra-persistence-uploader;new_password_sha256="d9fb903c32fe851f5d5543f2f9da27330ead9bd0d85ce8f51afba5d503f027a5"}'
    /usr/bin/yt create map_node '//sys/cypress_tokens/d9fb903c32fe851f5d5543f2f9da27330ead9bd0d85ce8f51afba5d503f027a5' --ignore-existing
    /usr/bin/yt set '//sys/cypress_tokens/d9fb903c32fe851f5d5543f2f9da27330ead9bd0d85ce8f51afba5d503f027a5/@user' 'robot-hydra-persistence-uploader'
    /usr/bin/yt create map_node //sys/admin/snapshots -r -i
    /usr/bin/yt set //sys/admin/snapshots/@acl '[{action=allow;subjects=["robot-hydra-persistence-uploader";];permissions=[read;write;remove;create;];"inheritance_mode"="object_and_descendants";};]'
    /usr/bin/yt set //sys/accounts/sys/@acl/end '{action=allow;subjects=["robot-hydra-persistence-uploader";];permissions=[use;];}'
    fi
    fi
    /usr/bin/yt remove //sys/@provision_lock -f
metadata:
  creationTimestamp: null
  labels:
    app.kubernetes.io/component: yt-master
    app.kubernetes.io/managed-by: ytsaurus-k8s-operator
    app.kubernetes.io/name: yt-master
    app.kubernetes.io/part-of: yt-test-ytsaurus
    yt_component: test-ytsaurus-yt-master
    ytsaurus.tech/cluster-name: test-ytsaurus
  name: default-yt-master-init-job-config
  namespace: ytsaurus-components
  ownerReferences:
  - apiVersion: cluster.ytsaurus.tech/v1
    blockOwnerDeletion: true
    controller: true
    kind: Ytsaurus
    name: test-ytsaurus
    uid: ""
  resourceVersion: "1"
