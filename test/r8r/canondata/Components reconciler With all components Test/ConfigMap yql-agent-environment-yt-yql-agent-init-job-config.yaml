apiVersion: v1
data:
  client.yson: |-
    {
        "address_resolver"={
            "enable_ipv4"=%true;
            "enable_ipv6"=%false;
            retries=1000;
        };
        logging={
            writers={
            };
            rules=[
            ];
            "flush_period"=0;
        };
        driver={
            "api_version"=4;
            "default_rpc_proxy_address_type"="public_rpc";
            "cluster_name"="test-ytsaurus";
            "primary_master"={
                addresses=[
                    "ms-0.masters.ytsaurus-components.svc.cluster.local:9010";
                ];
                peers=[
                    {
                        address="ms-0.masters.ytsaurus-components.svc.cluster.local:9010";
                        voting=%true;
                    };
                ];
                "cell_id"="65726e65-ad6b7562-10259-79747361";
            };
            "discovery_connection"={
                addresses=[
                    "ds-0.discovery.ytsaurus-components.svc.cluster.local:9020";
                ];
            };
            "bus_client"={
                "encryption_mode"=required;
                "cert_chain"={
                    "file_name"="/tls/bus_client_secret/tls.crt";
                };
                "private_key"={
                    "file_name"="/tls/bus_client_secret/tls.key";
                };
                ca={
                    "file_name"="/tls/ca_bundle/ca.crt";
                };
                "verification_mode"=full;
                "peer_alternative_host_name"="test-ytsaurus";
            };
            "master_cache"={
                addresses=[
                    "msc-0.master-caches.ytsaurus-components.svc.cluster.local:9018";
                ];
                "cell_id"="65726e65-ad6b7562-10259-79747361";
                "enable_master_cache_discovery"=%false;
            };
        };
    }
  init-cluster.sh: |2-

    set -e
    set -x

    export YT_DRIVER_CONFIG_PATH=/config/client.yson
    export YTSAURUS_VERSION="$(/usr/bin/ytserver-all --version | head -c4)"
    /usr/bin/yt create user --attributes '{name="yql_agent"}' --ignore-existing
    /usr/bin/yt create map_node '//sys/cypress_tokens/dcd89cc6efae0df4e42a9941000a5d1f4704e17162e02fbbae2e176989421ea4' --ignore-existing
    /usr/bin/yt set '//sys/cypress_tokens/dcd89cc6efae0df4e42a9941000a5d1f4704e17162e02fbbae2e176989421ea4/@user' 'yql_agent'
    /usr/bin/yt add-member yql_agent superusers || true
    /usr/bin/yt create user --attributes '{name="yql_agent"}' --ignore-existing
    /usr/bin/yt add-member yql_agent superusers || true
    /usr/bin/yt add-member --member yql_agent --group superusers || true
    /usr/bin/yt create document //sys/yql_agent/config --attributes '{value={}}' --recursive --ignore-existing
    /usr/bin/yt set //sys/@cluster_connection/yql_agent '{stages={production={channel={disable_balancing_on_single_address=%false;addresses=["yqla-0.yql-agents.ytsaurus-components.svc.cluster.local:9019";]}}}}'
    /usr/bin/yt get //sys/@cluster_connection | /usr/bin/yt set //sys/clusters/test-ytsaurus
kind: ConfigMap
metadata:
  annotations:
    extra-pod-annotation: "true"
    ytsaurus.tech/config-checksum: af1c9495536671a6539e2fdb35286698862d19c941ad82d8807944abcec04bde
  creationTimestamp: null
  generation: 1
  labels:
    app.kubernetes.io/component: yt-yql-agent
    app.kubernetes.io/managed-by: ytsaurus-k8s-operator
    app.kubernetes.io/name: yt-yql-agent
    app.kubernetes.io/part-of: yt-test-ytsaurus
    yt_component: test-ytsaurus-yt-yql-agent
    ytsaurus.tech/cluster-name: test-ytsaurus
  name: yql-agent-environment-yt-yql-agent-init-job-config
  namespace: ytsaurus-components
  ownerReferences:
  - apiVersion: cluster.ytsaurus.tech/v1
    blockOwnerDeletion: true
    controller: true
    kind: Ytsaurus
    name: test-ytsaurus
    uid: ""
  resourceVersion: "1"
